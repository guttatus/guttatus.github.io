+++
author = "guttatus"
title = "跨过那个时钟域(1)"
date = "2023-08-12"
description = "浅谈数字电路设计中跨时钟域相关概念及单比特信号跨时钟域的同步处理方法"
tags = [
    "CDC",
]
categories = [
    "IC",
]
toc = true
+++

##  时钟域概念
在同步时序电路中，一个时钟通常驱动（Feed）许多同步单元（触发器，同步RAM块等）。由同一时钟驱动的一组同步单元被称为该时钟的**时钟域**（Clock Domain）。


## 跨时钟域概念
**跨时钟域**(Clock Domain Crossing,CDC)是指同步数字电路中的信号从一个时钟域跨越到另一个时钟域。

### 亚稳态
对于边缘触发的触发器，触发器的建立时间(setup)和保持时间(hold)在时钟上升沿左右定义了一个时间窗口。如果输入数据在该窗口发生变化，那么就会产生时序违约。此时，触发器无法稳定在0或1状态，而是徘徊在一个中间电平状态（这个中间电平可能是正确值，也可能不是），得到的结果将是不可预知的。这种状态称为**亚稳态**(Metastability)。

## 单比特信号跨时钟域的同步处理方法

当在时钟域之间传递信号时，我们需要考虑一个重要的问题：是否要对从一个时钟域传输到另一个时钟域的信号的每一个值进行采样？

针对上述问题，当信号跨越时钟域边界时有两种可能的场景：
1. 在跨时钟域时允许丢失部分采样值。
2. 在跨时钟域时不允许丢失任何信号采样值。

对于第一种场景，有时对信号的每一个值进行采样是不必要的，但是被采样的值必须要保证精确度。标准异步 FIFO 设计中使用的一组格雷码计数器就是一个例子。在设计得当的异步 FIFO 模型中，同步格雷码计数器不需要捕获来自另一时钟域的每一个合法值，但采样值必须准确无误，以便识别何时出现了满和空的情况。

对于第二种场景，在允许对跨时钟域信号发生改变之前，必须被正确识别或识别并确认。

在这两种情况下，跨时钟域信号都需要被同步到其接受时钟域中。

###  双触发同步器

> **同步器**是对异步信号进行采样，并输出与本地时钟或采样时钟同步转换的信号的设备。

如下图所示，数字电路设计中，最简单和普遍的是使用**双触发同步器**（Two flip-flop synchronizer），也就是所谓的“打两拍”。

![Two-flip-flop](/img/posts/cdc/twoflipflop.png)

值得注意的是，即使通过使用双触发同步器消除了亚稳态，也并不意味着第二级Flop所采到的值就是**正确**的，而只能保证其是**稳定**的。

当然，从理论上，由于第一阶段的信号在打一拍后还是有可能处于非稳定状态，从而导致级联的第二个寄存器输出还会表现为非稳定状态。


>触发器进入亚稳态的时间可以用参数 **MTBF**(mean time between failures)来描述， MTBF即触发器采样失败的时间间隔，其公式描述如下：
$$ MTBF = \frac{e^{{t_R}/\tau}}{f_df_cT_0} $$
$t_R$ = 分辨时间（resolution time, the time after the clock edge that output data is needed）  
$\tau, T_0$ = 触发器参数，由工艺决定  
$f_d$ = 数据改变频率  
$f_c$ = 采样时钟频率    
从上述公式中我们可以看出，随着时钟频率的提高或者数据改变频率的提高，失败会发生的更频繁。

对于大多数同步应用，双触发同步器已经足够消除可能的亚稳态了。（存疑，该结论今天是否任然适用？）

### 三级触发同步器
对于一些高速设计，使用两级触发器同步未必能满足要求，这时可以额外添加一级触发器来增加MTBF。  

下图展示了一个三级触发同步器。

<img src="/img/posts/cdc/threeff.png" style="margin: 0 auto;" />


## to be continued